# 最小二乘法矩阵推导详解

## 🎯 为什么求偏导能找到最优解？

### 核心思想（回顾高中知识）

还记得高中求函数极值吗？

**一元函数**：`f(x) = x² - 4x + 5`
1. 求导：`f'(x) = 2x - 4`
2. 令导数为0：`2x - 4 = 0` → `x = 2`
3. 在 x=2 处取得最小值

**原理**：导数为0 → 切线水平 → 可能是极值点（山顶或山谷）

---

### 扩展到多元函数

**多元函数**也一样！对于 `f(x, y)`：
- 想找极值点（山谷或山顶）
- 需要**所有方向**的斜率都为0
- 即：`∂f/∂x = 0` 且 `∂f/∂y = 0`

**这就是为什么求偏导能找到最优解！**

---

## 📐 最小二乘法完整推导

### 问题设定

在推导最小二乘法时，需要将 X、y 和 w 系数都看作是一个整体（矩阵），然后进行矩阵的加减乘和求导。

在计算过程中：
- **w** 是未知数（要求解的参数）
- **X, y** 是已知数（训练数据）
- 为了求出 w，需要对代价函数 J 关于矩阵 w 求偏导数

---

### 第一步：建立损失函数

假设我们有 n 个数据点：`(x₁, y₁), (x₂, y₂), ..., (xₙ, yₙ)`

要拟合直线：**y = wx + b**

**损失函数**（误差平方和）：

```
J(w, b) = Σᵢ₌₁ⁿ (yᵢ - ŷᵢ)²
        = Σᵢ₌₁ⁿ (yᵢ - (wxᵢ + b))²
```

目标：找到使 J(w, b) 最小的 w 和 b

---

### 第二步：对 w 求偏导（把 b 当常数）

**原函数**：
```
J(w, b) = Σ(yᵢ - wxᵢ - b)²
```

**求偏导**（使用链式法则）：

```
∂J/∂w = ∂/∂w [Σ(yᵢ - wxᵢ - b)²]

展开：
= Σ ∂/∂w [(yᵢ - wxᵢ - b)²]

应用链式法则（外层是平方，内层是括号内容）：
= Σ 2(yᵢ - wxᵢ - b) · ∂/∂w(yᵢ - wxᵢ - b)

对w求导（yᵢ和b是常数）：
= Σ 2(yᵢ - wxᵢ - b) · (-xᵢ)

化简：
= -2Σ xᵢ(yᵢ - wxᵢ - b)
```

**令偏导数为0**：
```
-2Σ xᵢ(yᵢ - wxᵢ - b) = 0
Σ xᵢyᵢ - wΣxᵢ² - bΣxᵢ = 0  ... 方程①
```

---

### 第三步：对 b 求偏导（把 w 当常数）

**原函数**：
```
J(w, b) = Σ(yᵢ - wxᵢ - b)²
```

**求偏导**：

```
∂J/∂b = ∂/∂b [Σ(yᵢ - wxᵢ - b)²]

展开：
= Σ ∂/∂b [(yᵢ - wxᵢ - b)²]

应用链式法则：
= Σ 2(yᵢ - wxᵢ - b) · ∂/∂b(yᵢ - wxᵢ - b)

对b求导：
= Σ 2(yᵢ - wxᵢ - b) · (-1)

化简：
= -2Σ(yᵢ - wxᵢ - b)
```

**令偏导数为0**：
```
-2Σ(yᵢ - wxᵢ - b) = 0
Σyᵢ - wΣxᵢ - nb = 0  ... 方程②
```

---

### 第四步：联立方程求解

从**方程②**可得：
```
nb = Σyᵢ - wΣxᵢ
b = (Σyᵢ - wΣxᵢ) / n
b = ȳ - w·x̄    ← 截距公式
```

其中 `x̄ = Σxᵢ/n`（x的平均值），`ȳ = Σyᵢ/n`（y的平均值）

将 `b = ȳ - w·x̄` 代入**方程①**：
```
Σxᵢyᵢ - wΣxᵢ² - (ȳ - w·x̄)Σxᵢ = 0
Σxᵢyᵢ - wΣxᵢ² - ȳΣxᵢ + w·x̄·Σxᵢ = 0
```

注意：`Σxᵢ = n·x̄`，所以 `x̄·Σxᵢ = n·x̄²`

```
Σxᵢyᵢ - wΣxᵢ² - n·x̄·ȳ + w·n·x̄² = 0
w(Σxᵢ² - n·x̄²) = n·x̄·ȳ - Σxᵢyᵢ
```

最终得到**斜率公式**：
```
w = (Σxᵢyᵢ - n·x̄·ȳ) / (Σxᵢ² - n·x̄²)
  = Σ(xᵢ - x̄)(yᵢ - ȳ) / Σ(xᵢ - x̄)²
```

---

## 🎓 总结

### 完整公式

**斜率**：
```
w = Σ(xᵢ - x̄)(yᵢ - ȳ) / Σ(xᵢ - x̄)²
```

**截距**：
```
b = ȳ - w·x̄
```

### 为什么这样求？

1. **建立损失函数** J(w, b)（误差平方和）
2. **对w和b分别求偏导**（找极值的必要条件）
3. **令偏导数为0**（极值点的斜率为0）
4. **解方程组**得到最优参数

### 核心思想

> **"偏导数为0的地方，就是山谷（最小值点）"**

对于凸函数（如平方损失），这个方法保证能找到全局最优解！

---

## 📊 矩阵形式

上面是标量形式（适合单变量）。当有多个特征时，需要用矩阵形式：

**矩阵表示**：
```
y = Xw
```

**损失函数**：
```
J(w) = (y - Xw)ᵀ(y - Xw)
```

**对w求偏导并令为0**：
```
∂J/∂w = -2Xᵀ(y - Xw) = 0
Xᵀy - XᵀXw = 0
```

**最优解**：
```
w = (XᵀX)⁻¹Xᵀy
```

这就是著名的**正规方程**（Normal Equation）！

---

## 💡 记忆要点

1. **求偏导找极值**：多元函数的极值点，所有偏导数都为0
2. **链式法则**：复合函数求导，一层一层往外剥
3. **矩阵形式更优雅**：`w = (XᵀX)⁻¹Xᵀy` 一行代码搞定
4. **凸函数保证最优**：平方损失函数是凸的，偏导为0必是全局最小值